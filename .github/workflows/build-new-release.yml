name: Build New Release

on:
  pull_request:
  push:
  workflow_dispatch:
  
env:
  TIZEN_STUDIO_VER: 4.5.1

jobs:
  build:
    name: Build artifacts
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - artifact_name: Jellyfin
            web_ref: avplay


    steps:
      - run: env
      
      - name: 'Checkout'
        uses: actions/checkout@v5
      
      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: 'v23.11.1'
          
      - name: Install Needed packages
        run: sudo apt install expect
      
      - name: Download Tizen-Studio
        run: |
          curl -o tizen-installer "https://download.tizen.org/sdk/Installer/tizen-studio_${TIZEN_STUDIO_VER}/web-cli_Tizen_Studio_${TIZEN_STUDIO_VER}_ubuntu-64.bin"

      - name: Install Tizen-Studio
        run: |
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          echo 'export PATH=$PATH:/tizen-studio/tools/ide/bin' >> .bashrc
          
      - name: Prepare Tizen Certificate
        run: |
          # echo $CERTIFICATE_CONTENT > "${GITHUB_WORKSPACE}/tizencert.p12"
          # ./tizen-studio/tools/ide/bin/tizen certificate -a Jellyfin -p 1234 -c NZ -s Aukland -ct Aukland -o Tizen -n Jellyfin -e jellyfin@example.org -f tizencert
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n Jellyfin -a "${GITHUB_WORKSPACE}/tizencert.p12" -p 1234
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=${GITHUB_WORKSPACE}/tizen-studio-data/profile/profiles.xml"
          chmod 755 "${GITHUB_WORKSPACE}/tizen-studio-data/profile/profiles.xml"
        #env:
          #CERTIFICATE_CONTENT: ${{ secrets.TIZEN_CERT }}
    
      - name: Clone hacked jellyfin-tizen
        uses: actions/checkout@v5
        with:
          repository: kinke/jellyfin-tizen
          path: 'jellyfin-tizen'
          ref: avplay2

      - name: Clone hacked jellyfin-web
        uses: actions/checkout@v5
        with:
          repository: kinke/jellyfin-web
          path: 'jellyfin-web'
          ref: ${{ matrix.web_ref }}
          
      - name: Build jellyfin-web
        run: |
          cd jellyfin-web

          npm ci --no-audit
          USE_SYSTEM_FONTS=1 npm run build:development

      - name: Build jellyfin-tizen
        id: buildMaster
        run: |
          cd jellyfin-tizen
          
          JELLYFIN_WEB_DIR=../jellyfin-web/dist npm ci --no-audit

      - name: Build Package
        if: success() || steps.buildMaster.conclusion == 'success'
        run: |
          cd jellyfin-tizen
          ../tizen-studio/tools/ide/bin/tizen build-web -e ".*" -e gulpfile.js -e README.md -e "node_modules/*" -e "package*.json" -e "yarn.lock"
          
      - name: Prepare for password prompt
        if: success() || steps.buildMaster.conclusion == 'success'
        run: |
          sed -i "s|${GITHUB_WORKSPACE}/tizencert.pwd|1234|g" ${GITHUB_WORKSPACE}/tizen-studio-data/profile/profiles.xml
          sed -i "s|${GITHUB_WORKSPACE}/tizen-studio-data/tools/certificate-generator/certificates/distributor/tizen-distributor-signer.pwd|tizenpkcs12passfordsigner|g" ${GITHUB_WORKSPACE}/tizen-studio-data/profile/profiles.xml
          sed -i 's|password=""|password="tizenpkcs12passfordsigner"|g' ${GITHUB_WORKSPACE}/tizen-studio-data/profile/profiles.xml
          
      - name: Package WGT
        if: success() || steps.buildMaster.conclusion == 'success'
        run: |
          expect ./package.exp
          
      - name: Print logs
        if: always()
        run: cat ./tizen-studio-data/cli/logs/cli.log

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: jellyfin-tizen/release/${{ matrix.artifact_name }}.wgt
